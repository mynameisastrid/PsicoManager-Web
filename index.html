<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PsicoManager v9.5 - Hist√≥rico Din√¢mico & Supabase</title>
    <!-- Importando o cliente Supabase via CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary: #4f46e5;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #334155;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --gray: #94a3b8;
        }

        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }

        header { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; border-bottom: 1px solid #e2e8f0; padding-bottom: 20px; }
        @media(min-width: 600px) { header { flex-direction: row; justify-content: space-between; align-items: center; } }

        .month-selector { display: flex; align-items: center; gap: 15px; background: white; padding: 5px 15px; border-radius: 50px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .btn-nav { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--primary); font-weight: bold; }
        #currentMonthLabel { font-weight: 700; min-width: 150px; text-align: center; }

        .header-actions { display: flex; gap: 10px; }
        .btn-backup { background: var(--text); color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; }
        .btn-backup:hover { background: #000; }
        .btn-logout { background: transparent; color: var(--danger); border: 1px solid var(--danger); padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: 600;}
        .btn-logout:hover { background: var(--danger); color: white; }

        .tabs { display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 2px solid #e2e8f0; }
        .tab-btn { padding: 12px 24px; background: transparent; border: none; font-weight: 600; color: #94a3b8; cursor: pointer; border-bottom: 3px solid transparent; margin-bottom: -2px; }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); background: white; border-radius: 8px 8px 0 0; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from {opacity:0} to {opacity:1} }

        .sub-tabs { display: flex; gap: 10px; margin-bottom: 15px; background: #e2e8f0; padding: 5px; border-radius: 8px; width: fit-content; }
        .sub-tab { border: none; background: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 600; color: #64748b; transition: all 0.2s; }
        .sub-tab.active { background: white; color: var(--primary); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

        .dashboard-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .card { background: var(--card); padding: 20px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border-left: 5px solid transparent; }
        .card.blue { border-left-color: var(--primary); }
        .card.green { border-left-color: var(--success); }
        .card-val { font-size: 1.8rem; font-weight: 800; margin: 10px 0; }
        .card-lbl { font-size: 0.8rem; color: #64748b; text-transform: uppercase; font-weight: 700; }

        .main-grid { display: grid; grid-template-columns: 350px 1fr; gap: 25px; }
        @media (max-width: 800px) { .main-grid { grid-template-columns: 1fr; } }
        .form-box { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; margin-bottom: 15px; box-sizing: border-box; font-family: inherit; }
        label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 5px; color: #475569; }
        button.btn-primary { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        button.btn-primary:hover { background: #4338ca; }
        button.btn-danger { background: var(--danger); }
        button.btn-danger:hover { background: #b91c1c; }
        button.btn-secondary { background: #e2e8f0; color: #475569; }
        button.btn-secondary:hover { background: #cbd5e1; }
        button.btn-warning { background: var(--warning); color: #fff; }
        button.btn-warning:hover { background: #d97706; }

        .patient-card { background: white; border: 1px solid #e2e8f0; border-radius: 10px; padding: 15px; margin-bottom: 12px; transition: opacity 0.3s; }
        .patient-card.archived { border-left: 4px solid var(--gray); background: #f8fafc; }
        .p-header { display: flex; justify-content: space-between; align-items: center; }
        .p-actions { display: flex; gap: 8px; }
        .btn-icon { background: none; border: none; cursor: pointer; font-size: 1rem; padding: 4px; border-radius: 4px; transition: background 0.2s; }
        .btn-icon:hover { background: #f1f5f9; }
        
        .p-dates { display: flex; gap: 5px; flex-wrap: wrap; margin-top: 10px; }
        .date-chip { font-size: 0.75rem; padding: 4px 8px; border-radius: 20px; border: 1px solid #e2e8f0; cursor: pointer; user-select: none; }
        .date-chip.pending { background: #f1f5f9; color: #64748b; }
        .date-chip.done { background: #dcfce7; color: #166534; border-color: #bbf7d0; }
        .date-chip.missed { background: #fee2e2; color: #991b1b; border-color: #fecaca; }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 2000; backdrop-filter: blur(2px); opacity: 0; transition: opacity 0.2s; }
        .modal-overlay.active { display: flex; opacity: 1; }
        .modal-box { background: white; padding: 30px; border-radius: 16px; width: 90%; max-width: 450px; position: relative; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); transform: scale(0.95); transition: transform 0.2s; max-height: 90vh; overflow-y: auto;}
        .modal-overlay.active .modal-box { transform: scale(1); }
        .modal-close { position: absolute; top: 15px; right: 15px; border: none; background: none; font-size: 1.2rem; cursor: pointer; }

        /* Login & Setup Screen Overrides */
        #loginOverlay { background: var(--bg); z-index: 9999; flex-direction: column; }
        .login-box { background: white; padding: 40px; border-radius: 16px; width: 100%; max-width: 450px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .login-logo { text-align: center; margin-bottom: 30px; }
        .login-logo h1 { color: var(--primary); margin: 0; font-size: 2rem; }
        .login-logo p { color: #64748b; margin: 5px 0 0 0; font-size: 0.9rem;}
        
        .setup-instructions { background: #f1f5f9; padding: 15px; border-radius: 8px; font-size: 0.8rem; margin-bottom: 20px; border-left: 4px solid var(--warning); }
        .sql-code { background: #1e293b; color: #a5b4fc; padding: 10px; border-radius: 6px; font-family: monospace; font-size: 0.75rem; overflow-x: auto; white-space: pre; margin: 10px 0;}
        
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; background: white; padding: 15px; border-radius: 12px; }
        .cal-header { text-align: center; font-size: 0.8rem; font-weight: bold; color: #94a3b8; }
        .cal-day { min-height: 80px; border: 1px solid #f1f5f9; border-radius: 6px; padding: 4px; }
        .cal-num { font-weight: bold; font-size: 0.8rem; color: #64748b; }
        .cal-event { font-size: 0.65rem; background: #e0e7ff; color: var(--primary); padding: 2px 4px; border-radius: 3px; margin-bottom: 2px; white-space: nowrap; overflow: hidden; }
        
        .history-table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; }
        .history-table th, .history-table td { padding: 12px; text-align: left; border-bottom: 1px solid #f1f5f9; }

        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { 
            background: white; padding: 15px 20px; border-radius: 8px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 12px; 
            animation: slideIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); pointer-events: all; 
            border-left: 5px solid var(--primary); min-width: 250px; font-weight: 500; font-size: 0.9rem;
        }
        .toast.success { border-left-color: var(--success); }
        .toast.error { border-left-color: var(--danger); }
        .toast.info { border-left-color: var(--primary); }
        .toast-icon { font-size: 1.2rem; }
        .toast-close { margin-left: auto; cursor: pointer; color: #94a3b8; font-size: 1.2rem; line-height: 1; }
        .toast-close:hover { color: var(--text); }
        
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.9); } }
    </style>
</head>
<body>

    <!-- Login & Supabase Setup Screen -->
    <div id="loginOverlay" class="modal-overlay active">
        <div class="login-box" id="authSection" style="display:none;">
            <div class="login-logo">
                <h1>Œ® PsicoManager</h1>
                <p>Acesse seu consult√≥rio via Supabase Cloud.</p>
            </div>
            <form id="loginForm">
                <label>E-mail</label>
                <input type="email" id="authEmail" required placeholder="seu@email.com">
                <label>Senha</label>
                <input type="password" id="authPassword" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                
                <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 20px;">
                    <button type="button" id="btnSignIn" class="btn-primary">Entrar</button>
                    <button type="button" id="btnSignUp" class="btn-primary btn-secondary">Criar Nova Conta</button>
                    <button type="button" onclick="showSetupSection()" style="background:none; border:none; color:var(--primary); cursor:pointer; font-size:0.8rem; margin-top:10px; text-decoration:underline;">Reconfigurar API do Supabase</button>
                </div>
            </form>
        </div>

        <div class="login-box" id="setupSection">
            <div class="login-logo">
                <h1>‚öôÔ∏è Configura√ß√£o</h1>
                <p>Conecte seu banco de dados Supabase.</p>
            </div>
            <div class="setup-instructions">
                <strong>1. No Painel do Supabase, v√° em SQL Editor e rode este c√≥digo para criar sua tabela e regras de seguran√ßa:</strong>
                <div class="sql-code">CREATE TABLE psico_data (
    user_id UUID PRIMARY KEY REFERENCES auth.users(id),
    data_json JSONB NOT NULL DEFAULT '{}'::jsonb
);

ALTER TABLE psico_data ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can manage their own data" 
ON psico_data FOR ALL USING (auth.uid() = user_id);</div>
            </div>
            <form id="setupForm">
                <label>Project URL</label>
                <input type="url" id="supaUrlInput" required placeholder="https://xxxxxx.supabase.co">
                <label>Project API Key (anon / public)</label>
                <input type="password" id="supaKeyInput" required placeholder="eyJhbGciOiJIUzI1NiIsInR...">
                
                <button type="button" id="btnSaveConfig" class="btn-primary" style="margin-top: 15px;">Salvar e Continuar</button>
            </form>
        </div>
    </div>

    <div id="toastContainer" class="toast-container"></div>

    <div id="deleteOptionsModal" class="modal-overlay">
        <div class="modal-box" style="text-align:center;">
            <div style="font-size: 3rem; margin-bottom: 10px;">üóëÔ∏è</div>
            <h3 style="margin-top:0; margin-bottom: 10px;">Excluir ou Dar Alta?</h3>
            <p style="color:#64748b; margin-bottom:25px;">Se o paciente recebeu alta, use "Dar Alta" para manter os dados financeiros dos meses passados.</p>
            
            <input type="hidden" id="deleteTargetId">
            
            <div style="display:flex; flex-direction:column; gap:10px;">
                <button class="btn-primary btn-warning" onclick="performSoftDelete()">
                    üìÅ Dar Alta (Manter Hist√≥rico)
                </button>
                <button class="btn-primary btn-danger" onclick="performHardDelete()">
                    ‚ùå Excluir Tudo (Permanente)
                </button>
                <button class="btn-primary btn-secondary" onclick="closeDeleteOptions()">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <div id="editModal" class="modal-overlay">
        <div class="modal-box">
            <button class="modal-close" onclick="closeEdit()">√ó</button>
            <h3 style="margin-top:0;">Editar Paciente</h3>
            <form id="editForm">
                <input type="hidden" id="editId">
                <label>Nome</label>
                <input type="text" id="editName" required>
                
                <div style="display:flex; gap:10px;">
                    <div style="flex:1"><label>Dia</label><select id="editDay"></select></div>
                    <div style="flex:1"><label>Hora</label><select id="editTime"></select></div>
                </div>

                <div style="display:flex; gap:10px;">
                    <div style="flex:1">
                        <label>Tipo</label>
                        <select id="editType">
                            <option value="package">Pacote</option>
                            <option value="single">Avulso</option>
                        </select>
                    </div>
                    <div style="flex:1">
                        <label>Qtd. Sess√µes</label>
                        <input type="number" id="editQtd" value="4">
                    </div>
                </div>

                <label>Valor (Pacote ou Sess√£o)</label>
                <input type="text" id="editVal" placeholder="0,00" oninput="applyCurrencyMask(this)">

                <button type="submit" class="btn-primary">Salvar Altera√ß√µes</button>
            </form>
        </div>
    </div>

    <div class="container">
        <header>
            <div>
                <h1 style="color: var(--primary); margin:0;">Œ® PsicoManager</h1>
                <small style="color:#64748b;">v9.5 ‚Ä¢ Supabase Sync & BRL</small>
            </div>
            
            <div class="month-selector">
                <button class="btn-nav" onclick="changeMonth(-1)">‚Äπ</button>
                <span id="currentMonthLabel">Carregando...</span>
                <button class="btn-nav" onclick="changeMonth(1)">‚Ä∫</button>
            </div>

            <div class="header-actions">
                <button class="btn-backup" onclick="downloadBackup()">üíæ Backup Local</button>
                <button class="btn-logout" id="btnLogout">Sair</button>
            </div>
        </header>

        <div class="tabs">
            <button class="tab-btn active" data-target="dashboard">Dashboard</button>
            <button class="tab-btn" data-target="calendar">Calend√°rio</button>
            <button class="tab-btn" data-target="history">Hist√≥rico</button>
        </div>

        <div id="dashboard" class="tab-content active">
            <div class="dashboard-cards">
                <div class="card blue">
                    <div class="card-lbl">Projetado (M√™s)</div>
                    <div class="card-val" id="dashProj">R$ 0,00</div>
                </div>
                <div class="card green">
                    <div class="card-lbl">Garantido (M√™s)</div>
                    <div class="card-val" style="color: var(--success);" id="dashReal">R$ 0,00</div>
                </div>
            </div>

            <div class="main-grid">
                <div class="form-box">
                    <h3 style="margin-top:0;">Novo Paciente</h3>
                    <form id="addForm">
                        <label>Nome</label>
                        <input type="text" id="pName" required placeholder="Ex: Lucas">

                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                            <div><label>Dia</label><select id="pDay" required></select></div>
                            <div><label>Hora</label><select id="pTime" required></select></div>
                        </div>

                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                            <div>
                                <label>Contrato</label>
                                <select id="pType" onchange="toggleAddInputs()">
                                    <option value="package">Pacote Mensal</option>
                                    <option value="single">Avulso</option>
                                </select>
                            </div>
                            <div>
                                <label>Qtd. Sess√µes</label>
                                <input type="number" id="pQtd" value="4" required>
                            </div>
                        </div>

                        <div id="pkgInputs">
                            <label>Valor Total do Pacote</label>
                            <input type="text" id="pValPkg" placeholder="800,00" oninput="applyCurrencyMask(this)">
                        </div>
                        <div id="sglInputs" style="display:none;">
                            <label>Valor por Sess√£o</label>
                            <input type="text" id="pValSgl" placeholder="200,00" oninput="applyCurrencyMask(this)">
                        </div>

                        <button type="submit" class="btn-primary">Cadastrar</button>
                    </form>
                </div>

                <div>
                    <div class="sub-tabs">
                        <button class="sub-tab active" id="btnTabActive" onclick="setDashView('active')">Em Tratamento</button>
                        <button class="sub-tab" id="btnTabArchived" onclick="setDashView('archived')">Altas M√©dicas</button>
                    </div>
                    <div id="patientsList"></div>
                </div>
            </div>
        </div>

        <div id="calendar" class="tab-content">
            <div class="calendar-grid" id="calendarGrid"></div>
        </div>

        <div id="history" class="tab-content">
            <table class="history-table">
                <thead><tr><th>M√™s</th><th>Pacientes Ativos</th><th>Realizado</th></tr></thead>
                <tbody id="historyBody"></tbody>
            </table>
        </div>
    </div>

<script>
    // Configura√ß√µes do Supabase
    let supabase = null;
    let currentUser = null;

    // Estado da Aplica√ß√£o
    let db = { patients: [], sessions: {} };
    let contextDate = new Date();
    let dashView = 'active'; 

    const MONTHS = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
    const DAYS = ["Domingo", "Segunda", "Ter√ßa", "Quarta", "Quinta", "Sexta", "S√°bado"];

    // Utils de Interface
    window.showToast = function(msg, type='success') {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        let icon = type === 'success' ? '‚úÖ' : (type === 'error' ? '‚ùå' : '‚ÑπÔ∏è');
        toast.innerHTML = `<span class="toast-icon">${icon}</span><span>${msg}</span><span class="toast-close" onclick="this.parentElement.remove()">√ó</span>`;
        container.appendChild(toast);
        setTimeout(() => {
            toast.style.animation = 'fadeOut 0.5s forwards';
            setTimeout(() => toast.remove(), 500);
        }, 3000);
    }

    // --- FORMATA√á√ÉO BRL ---
    window.applyCurrencyMask = function(input) {
        let value = input.value.replace(/\D/g, "");
        if (value === "") { input.value = ""; return; }
        let number = parseInt(value, 10) / 100;
        input.value = number.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    };

    function parseBRL(valueStr) {
        if (!valueStr) return 0;
        return parseFloat(valueStr.toString().replace(/\./g, '').replace(',', '.'));
    }

    function formatBRL(value) {
        return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
    }
    // ------------------------------------------

    // --- INICIALIZA√á√ÉO E SETUP SUPABASE ---
    document.addEventListener('DOMContentLoaded', () => {
        populateSelects('pDay', 'pTime');
        populateSelects('editDay', 'editTime');
        setupTabs();

        const savedUrl = localStorage.getItem('supa_url');
        const savedKey = localStorage.getItem('supa_key');

        if (savedUrl && savedKey) {
            initSupabaseClient(savedUrl, savedKey);
        } else {
            showSetupSection();
        }
    });

    window.showSetupSection = function() {
        document.getElementById('authSection').style.display = 'none';
        document.getElementById('setupSection').style.display = 'block';
        document.getElementById('supaUrlInput').value = localStorage.getItem('supa_url') || '';
        document.getElementById('supaKeyInput').value = localStorage.getItem('supa_key') || '';
    };

    document.getElementById('btnSaveConfig').onclick = () => {
        const url = document.getElementById('supaUrlInput').value.trim();
        const key = document.getElementById('supaKeyInput').value.trim();
        if (!url || !key) return showToast("Preencha URL e Key do Supabase", "error");

        localStorage.setItem('supa_url', url);
        localStorage.setItem('supa_key', key);
        initSupabaseClient(url, key);
        showToast("Configura√ß√£o salva!", "success");
    };

    function initSupabaseClient(url, key) {
        try {
            supabase = window.supabase.createClient(url, key);
            document.getElementById('setupSection').style.display = 'none';
            document.getElementById('authSection').style.display = 'block';
            checkActiveSession();
        } catch (error) {
            showToast("Erro ao conectar. Verifique URL/Key.", "error");
            showSetupSection();
        }
    }

    // --- AUTENTICA√á√ÉO REAL SUPABASE ---
    async function checkActiveSession() {
        const { data: { session } } = await supabase.auth.getSession();
        if (session) {
            currentUser = session.user;
            document.getElementById('loginOverlay').classList.remove('active');
            loadDataFromCloud();
        }
    }

    document.getElementById('btnSignIn').onclick = async () => {
        const email = document.getElementById('authEmail').value;
        const password = document.getElementById('authPassword').value;
        if(!email || !password) return showToast("Preencha email e senha", "warning");

        const { data, error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) {
            showToast(error.message, "error");
        } else {
            currentUser = data.user;
            document.getElementById('loginOverlay').classList.remove('active');
            document.getElementById('authPassword').value = '';
            loadDataFromCloud();
            showToast("Login realizado!", "success");
        }
    };

    document.getElementById('btnSignUp').onclick = async () => {
        const email = document.getElementById('authEmail').value;
        const password = document.getElementById('authPassword').value;
        if(!email || password.length < 6) return showToast("Senha deve ter ao menos 6 caracteres", "warning");

        const { data, error } = await supabase.auth.signUp({ email, password });
        if (error) {
            showToast(error.message, "error");
        } else {
            showToast("Conta criada! Se o Supabase exigir confirma√ß√£o, verifique seu e-mail.", "info");
            // Se o Supabase estiver configurado para auto-login sem verifica√ß√£o de e-mail:
            if(data.session) {
                currentUser = data.user;
                document.getElementById('loginOverlay').classList.remove('active');
                loadDataFromCloud();
            }
        }
    };

    document.getElementById('btnLogout').onclick = async () => {
        await supabase.auth.signOut();
        currentUser = null;
        db = { patients: [], sessions: {} }; // Limpa a mem√≥ria local
        document.getElementById('loginOverlay').classList.add('active');
        showToast("Voc√™ saiu com seguran√ßa.", "info");
    };

    // --- DATABASE SUPABASE (CRUD) ---
    async function loadDataFromCloud() {
        if (!currentUser || !supabase) return;
        showToast("Sincronizando...", "info");

        const { data, error } = await supabase
            .from('psico_data')
            .select('data_json')
            .eq('user_id', currentUser.id)
            .single();

        if (error && error.code !== 'PGRST116') { // PGRST116 = N√£o encontrou linha (novo usu√°rio)
            console.error(error);
            showToast("Erro ao carregar dados. A tabela 'psico_data' foi criada no SQL Editor?", "error");
            return;
        }

        if (data && data.data_json) {
            db = data.data_json;
            if (!db.patients) db.patients = [];
            if (!db.sessions) db.sessions = {};
        }
        
        renderAll();
    }

    async function saveToCloud() {
        renderAll(); // Atualiza UI imediatamente
        if (!currentUser || !supabase) return;

        const { error } = await supabase
            .from('psico_data')
            .upsert({ 
                user_id: currentUser.id, 
                data_json: db 
            });

        if (error) {
            console.error(error);
            showToast("Erro ao salvar na nuvem! Verifique as regras de seguran√ßa (RLS).", "error");
        }
    }

    // --- L√ìGICA DO APP ---

    window.setDashView = function(view) {
        dashView = view;
        document.getElementById('btnTabActive').classList.toggle('active', view === 'active');
        document.getElementById('btnTabArchived').classList.toggle('active', view === 'archived');
        renderAll();
    }

    window.downloadBackup = function() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
        const a = document.createElement('a');
        a.href = dataStr; a.download = "psico_backup_" + new Date().toISOString().slice(0,10) + ".json";
        document.body.appendChild(a); a.click(); a.remove();
        showToast("Backup local gerado com sucesso!", "info");
    }

    function setupTabs() {
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn, .tab-content').forEach(el => el.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(btn.dataset.target).classList.add('active');
            });
        });
    }

    function populateSelects(dayId, timeId) {
        const dSel = document.getElementById(dayId); dSel.innerHTML = '';
        for(let i=1; i<=6; i++) { const opt = document.createElement('option'); opt.value = i; opt.text = DAYS[i]; dSel.appendChild(opt); }
        const tSel = document.getElementById(timeId); tSel.innerHTML = '';
        for(let h=6; h<=22; h++) {
            for(let m=0; m<60; m+=15) {
                const t = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
                const opt = document.createElement('option'); opt.value = t; opt.text = t;
                if(t==="14:00") opt.selected = true; tSel.appendChild(opt);
            }
        }
    }

    window.toggleAddInputs = function() {
        const t = document.getElementById('pType').value;
        document.getElementById('pkgInputs').style.display = t==='package'?'block':'none';
        document.getElementById('sglInputs').style.display = t==='single'?'block':'none';
    }

    window.changeMonth = function(delta) { 
        contextDate.setMonth(contextDate.getMonth() + delta); 
        renderAll(); 
    }

    function getMonthKey(d) { return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; }
    
    function getDatesInMonth(year, month, dayOfWeek, maxCount) {
        let dates = []; let d = new Date(year, month, 1);
        while(d.getDay() !== dayOfWeek) d.setDate(d.getDate()+1);
        while(d.getMonth() === month) { dates.push(d.getDate()); d.setDate(d.getDate()+7); }
        return (maxCount && dates.length > maxCount) ? dates.slice(0, maxCount) : dates;
    }

    function checkConflict(day, time, excludeId = null) {
        return db.patients.some(p => p.active && p.day === day && p.time === time && p.id !== excludeId);
    }

    document.getElementById('addForm').onsubmit = (e) => {
        e.preventDefault();
        const day = parseInt(document.getElementById('pDay').value);
        const time = document.getElementById('pTime').value;

        if(checkConflict(day, time)) {
            showToast(`Ops! ${DAYS[day]} √†s ${time} j√° est√° ocupado.`, 'error');
            return;
        }

        const type = document.getElementById('pType').value;
        const rawVal = type === 'package' ? document.getElementById('pValPkg').value : document.getElementById('pValSgl').value;
        const val = parseBRL(rawVal);

        db.patients.push({
            id: Date.now(),
            name: document.getElementById('pName').value,
            day: day,
            time: time,
            type: type,
            val: val,
            qtd: parseInt(document.getElementById('pQtd').value) || 4,
            active: true,
            startMonth: getMonthKey(contextDate)
        });

        saveToCloud();
        e.target.reset();
        document.getElementById('pTime').value = "14:00";
        document.getElementById('pQtd').value = "4";
        window.toggleAddInputs();
        showToast("Paciente cadastrado com sucesso!", "success");
    };

    window.openEdit = function(id) {
        const p = db.patients.find(x => x.id === id);
        if(!p) return;
        document.getElementById('editId').value = p.id;
        document.getElementById('editName').value = p.name;
        document.getElementById('editDay').value = p.day;
        document.getElementById('editTime').value = p.time;
        document.getElementById('editType').value = p.type;
        
        const editValInput = document.getElementById('editVal');
        editValInput.value = (p.val).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        
        document.getElementById('editQtd').value = p.qtd || 4;
        document.getElementById('editModal').classList.add('active');
    }

    document.getElementById('editForm').onsubmit = (e) => {
        e.preventDefault();
        const id = Number(document.getElementById('editId').value);
        const day = parseInt(document.getElementById('editDay').value);
        const time = document.getElementById('editTime').value;

        if(checkConflict(day, time, id)) {
            showToast(`Ops! ${DAYS[day]} √†s ${time} j√° est√° ocupado.`, 'error');
            return;
        }

        const p = db.patients.find(x => x.id === id);
        if(p) {
            p.name = document.getElementById('editName').value;
            p.day = day;
            p.time = time;
            p.type = document.getElementById('editType').value;
            
            p.val = parseBRL(document.getElementById('editVal').value);
            p.qtd = Number(document.getElementById('editQtd').value);
            
            const currentKey = getMonthKey(contextDate);
            delete db.sessions[`${currentKey}_${id}`];
            
            saveToCloud();
            closeEdit();
            showToast("Dados atualizados!", "success");
        }
    };
    
    window.closeEdit = function() { document.getElementById('editModal').classList.remove('active'); }

    window.triggerDelete = function(id) {
        document.getElementById('deleteTargetId').value = id;
        document.getElementById('deleteOptionsModal').classList.add('active');
    }
    window.closeDeleteOptions = function() {
        document.getElementById('deleteOptionsModal').classList.remove('active');
        document.getElementById('deleteTargetId').value = '';
    }

    window.performSoftDelete = function() {
        const id = Number(document.getElementById('deleteTargetId').value);
        const p = db.patients.find(x => x.id === id);
        if(p) {
            p.active = false;
            saveToCloud();
            showToast("Paciente arquivado (Alta).", "info");
        }
        closeDeleteOptions();
    }

    window.performHardDelete = function() {
        const id = Number(document.getElementById('deleteTargetId').value);
        db.patients = db.patients.filter(p => p.id !== id);
        saveToCloud();
        showToast("Paciente exclu√≠do permanentemente.", "error");
        closeDeleteOptions();
    }

    window.reactivatePatient = function(id) {
        const p = db.patients.find(x => x.id === id);
        if(!p) return;

        if(checkConflict(p.day, p.time, p.id)) {
            showToast(`Conflito: ${DAYS[p.day]} √†s ${p.time} est√° ocupado! Edite o paciente antes de reativar.`, 'error');
            setTimeout(() => openEdit(id), 1500);
            return;
        }

        p.active = true;
        saveToCloud();
        showToast("Paciente reativado com sucesso!", "success");
        setDashView('active'); 
    }

    window.toggleSession = function(pid, idx, key) {
        const p = db.patients.find(x => x.id === pid);
        if(!p.active) {
            showToast("Reative o paciente para alterar sess√µes.", "info");
            return;
        }
        const sKey = `${key}_${pid}`;
        if(db.sessions[sKey]) {
            db.sessions[sKey][idx] = (db.sessions[sKey][idx] + 1) % 3;
            saveToCloud();
        }
    }

    function renderAll() {
        if(!currentUser || !supabase) return;

        document.getElementById('currentMonthLabel').innerText = `${MONTHS[contextDate.getMonth()]} ${contextDate.getFullYear()}`;
        const currentKey = getMonthKey(contextDate);
        const list = document.getElementById('patientsList');
        list.innerHTML = '';
        const grid = document.getElementById('calendarGrid');
        grid.innerHTML = ''; 
        DAYS.forEach(d => grid.innerHTML+=`<div class="cal-header">${d.substring(0,3)}</div>`);

        let projTotal = 0, realTotal = 0;
        let activeCount = 0;

        const year = contextDate.getFullYear();
        const month = contextDate.getMonth();
        const firstDay = new Date(year, month, 1).getDay();
        const totalDays = new Date(year, month+1, 0).getDate();
        for(let i=0; i<firstDay; i++) grid.innerHTML+=`<div class="day-empty"></div>`;
        let calDaysHTML = Array(totalDays).fill().map((_, i) => `<div class="cal-day"><span class="cal-num">${i+1}</span>`);

        db.patients.forEach(p => {
            if (p.startMonth && currentKey < p.startMonth) return;

            const dates = getDatesInMonth(year, month, p.day, p.qtd);
            const sKey = `${currentKey}_${p.id}`;

            if(!db.sessions[sKey] || db.sessions[sKey].length !== dates.length) { 
                if(p.active) db.sessions[sKey] = new Array(dates.length).fill(0); 
                else if(!db.sessions[sKey]) return; 
            }
            
            const statuses = db.sessions[sKey] || [];
            const hasFinancialHistory = statuses.some(s => s > 0); 

            let countsAsActiveInMonth = false;
            if(p.active) {
                countsAsActiveInMonth = true;
            } else {
                if(hasFinancialHistory) countsAsActiveInMonth = true;
            }

            if(countsAsActiveInMonth) activeCount++;

            if(p.active) {
                if(p.type === 'package') projTotal += p.val;
                else projTotal += p.val * dates.length;
            }
            
            if(p.type === 'package') {
                if(p.active || hasFinancialHistory) realTotal += (hasFinancialHistory || (p.active && statuses.some(s=>s===1))) ? p.val : 0;
            } else {
                realTotal += (statuses.filter(s=>s===1).length * p.val);
            }

            if(p.active) {
                dates.forEach((d, i) => {
                    let color = '#e0e7ff'; if(statuses[i]===1) color='#dcfce7'; if(statuses[i]===2) color='#fee2e2';
                    calDaysHTML[d-1] += `<div class="cal-event" style="background:${color}">${p.time} ${p.name}</div>`;
                });
            }

            let shouldRender = false;
            if(dashView === 'active' && p.active) shouldRender = true;
            if(dashView === 'archived' && !p.active) shouldRender = true;

            if(shouldRender) {
                let chips = '';
                dates.forEach((d, i) => {
                    let cls = 'pending'; if(statuses[i]===1) cls='done'; if(statuses[i]===2) cls='missed';
                    chips += `<div class="date-chip ${cls}" onclick="toggleSession(${p.id}, ${i}, '${currentKey}')">${d}</div>`;
                });

                const div = document.createElement('div'); 
                div.className = `patient-card ${!p.active ? 'archived' : ''}`;
                
                let actionButtons = '';
                if(p.active) {
                    actionButtons = `
                        <button class="btn-icon" onclick="openEdit(${p.id})">‚úèÔ∏è</button>
                        <button class="btn-icon" onclick="triggerDelete(${p.id})" style="color:red;">üóëÔ∏è</button>
                    `;
                } else {
                    actionButtons = `
                        <button class="btn-icon" onclick="reactivatePatient(${p.id})" style="color:var(--success);" title="Reativar Paciente">‚ôªÔ∏è</button>
                        <button class="btn-icon" onclick="triggerDelete(${p.id})" style="color:red;">üóëÔ∏è</button>
                    `;
                }

                div.innerHTML = `
                    <div class="p-header">
                        <div>
                            <strong>${p.name}</strong> 
                            ${!p.active ? '<span style="font-size:0.7rem; background:#cbd5e1; padding:2px 6px; border-radius:4px; margin-left:5px;">Alta / Arquivado</span>' : ''}
                            <span style="font-size:0.8rem;color:#666;">(${dates.length} sess√µes)</span>
                        </div>
                        <div class="p-actions">${actionButtons}</div>
                    </div>
                    <div style="font-size:0.8rem;color:#64748b;">
                        ${DAYS[p.day]} - ${p.time} ‚Ä¢ ${p.type === 'package' ? 'Pacote' : 'Avulso'} ‚Ä¢ <strong>${formatBRL(p.val)}</strong>
                    </div>
                    <div class="p-dates">${chips}</div>`;
                list.appendChild(div);
            }
        });

        document.getElementById('dashProj').innerText = formatBRL(projTotal);
        document.getElementById('dashReal').innerText = formatBRL(realTotal);
        
        calDaysHTML.forEach(html => grid.innerHTML += (html + '</div>'));

        const histBody = document.getElementById('historyBody'); histBody.innerHTML = '';
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${MONTHS[month]}/${year}</td><td>${activeCount}</td><td style="color:var(--success);font-weight:bold;">${formatBRL(realTotal)}</td>`;
        histBody.appendChild(tr);
    }
</script>
</body>
</html>